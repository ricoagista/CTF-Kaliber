const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Game variables
let player = {
    x: canvas.width / 2 - 50,
    y: canvas.height - 120,
    width: 100,
    height: 100,
    speed: 5,
    img: new Image()
};

let bullets = [];
let enemies = [];
let gameRunning = false;
let score = 0;
let totalDamage = 0;
let shotsFired = 0;
let keys = {};

// Load player image
player.img.src = 'assets/1.png';
player.img.onload = function() {
    console.log('Player plane loaded!');
};

// Enemy class
class Enemy {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.width = 60;
        this.height = 60;
        this.speed = 2;
        this.hp = 30;
        this.maxHp = 30;
    }
    
    draw() {
        // Enemy plane (simple triangle for now, bisa diganti dengan image)
        ctx.fillStyle = '#e74c3c';
        ctx.beginPath();
        ctx.moveTo(this.x + this.width / 2, this.y + this.height);
        ctx.lineTo(this.x, this.y);
        ctx.lineTo(this.x + this.width, this.y);
        ctx.closePath();
        ctx.fill();
        
        // HP bar
        ctx.fillStyle = '#2ecc71';
        ctx.fillRect(this.x, this.y - 10, (this.width * this.hp) / this.maxHp, 5);
        ctx.strokeStyle = '#fff';
        ctx.strokeRect(this.x, this.y - 10, this.width, 5);
    }
    
    update() {
        this.y += this.speed;
    }
}

// Bullet class
class Bullet {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.width = 4;
        this.height = 15;
        this.speed = 7;
        this.damage = Math.floor(Math.random() * 21) + 10; // 10-30 damage
    }
    
    draw() {
        ctx.fillStyle = '#00ff00';
        ctx.fillRect(this.x, this.y, this.width, this.height);
        ctx.shadowColor = '#00ff00';
        ctx.shadowBlur = 10;
        ctx.fillRect(this.x, this.y, this.width, this.height);
        ctx.shadowBlur = 0;
    }
    
    update() {
        this.y -= this.speed;
    }
}

// Keyboard controls
document.addEventListener('keydown', (e) => {
    keys[e.key] = true;
    if (e.key === ' ' && gameRunning) {
        shoot();
        e.preventDefault();
    }
});

document.addEventListener('keyup', (e) => {
    keys[e.key] = false;
});

// Mouse click to shoot
canvas.addEventListener('click', () => {
    if (gameRunning) shoot();
});

function startGame() {
    gameRunning = true;
    totalDamage = 0;
    shotsFired = 0;
    bullets = [];
    enemies = [];
    score = 0;
    
    document.getElementById('startBtn').disabled = true;
    document.getElementById('submitBtn').disabled = false;
    
    spawnEnemies();
    gameLoop();
    
    console.log('%cüéÆ GAME STARTED!', 'color: #2ecc71; font-size: 20px; font-weight: bold;');
    console.log('%cüí° CTF Hint: Cek hidden input "damageValue"...', 'color: #f39c12; font-size: 14px;');
}

function shoot() {
    const bullet = new Bullet(player.x + player.width / 2 - 2, player.y);
    bullets.push(bullet);
    shotsFired++;
    
    console.log(`üî´ Shot fired! Damage: ${bullet.damage}`);
}

function spawnEnemies() {
    setInterval(() => {
        if (gameRunning && enemies.length < 5) {
            const x = Math.random() * (canvas.width - 60);
            enemies.push(new Enemy(x, -60));
        }
    }, 2000);
}

function drawPlayer() {
    if (player.img.complete) {
        ctx.drawImage(player.img, player.x, player.y, player.width, player.height);
    } else {
        // Fallback if image not loaded
        ctx.fillStyle = '#3498db';
        ctx.beginPath();
        ctx.moveTo(player.x + player.width / 2, player.y);
        ctx.lineTo(player.x, player.y + player.height);
        ctx.lineTo(player.x + player.width, player.y + player.height);
        ctx.closePath();
        ctx.fill();
    }
}

function updatePlayer() {
    if ((keys['ArrowLeft'] || keys['a'] || keys['A']) && player.x > 0) {
        player.x -= player.speed;
    }
    if ((keys['ArrowRight'] || keys['d'] || keys['D']) && player.x < canvas.width - player.width) {
        player.x += player.speed;
    }
}

function checkCollisions() {
    bullets.forEach((bullet, bulletIndex) => {
        enemies.forEach((enemy, enemyIndex) => {
            if (bullet.x < enemy.x + enemy.width &&
                bullet.x + bullet.width > enemy.x &&
                bullet.y < enemy.y + enemy.height &&
                bullet.y + bullet.height > enemy.y) {
                
                // Hit detected!
                enemy.hp -= bullet.damage;
                totalDamage += bullet.damage;
                
                // Update display
                document.getElementById('currentDamage').textContent = totalDamage;
                document.getElementById('damageValue').value = totalDamage;
                document.getElementById('shotsValue').value = shotsFired;
                
                // Remove bullet
                bullets.splice(bulletIndex, 1);
                
                // Check if enemy destroyed
                if (enemy.hp <= 0) {
                    enemies.splice(enemyIndex, 1);
                    score++;
                    console.log(`üí• Enemy destroyed! Total damage: ${totalDamage}`);
                }
            }
        });
    });
}

function gameLoop() {
    if (!gameRunning) return;
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Update and draw player
    updatePlayer();
    drawPlayer();
    
    // Update and draw bullets
    bullets.forEach((bullet, index) => {
        bullet.update();
        bullet.draw();
        
        // Remove bullets that are off screen
        if (bullet.y < 0) {
            bullets.splice(index, 1);
        }
    });
    
    // Update and draw enemies
    enemies.forEach((enemy, index) => {
        enemy.update();
        enemy.draw();
        
        // Remove enemies that are off screen
        if (enemy.y > canvas.height) {
            enemies.splice(index, 1);
        }
    });
    
    // Check collisions
    checkCollisions();
    
    requestAnimationFrame(gameLoop);
}

// Console hints
console.log('%c‚úàÔ∏è 1941 AIR ATTACK', 'color: #f39c12; font-size: 24px; font-weight: bold;');
console.log('%cüí° CTF Challenge: Manipulate damage to crash the system!', 'color: #3498db; font-size: 16px;');
console.log('%cüéØ Hint: Apa yang terjadi jika damage bernilai negatif?', 'color: #2ecc71; font-size: 14px;');
console.log('%cüîß Try: document.getElementById("damageValue").value = -9999', 'color: #e74c3c; font-size: 14px;');