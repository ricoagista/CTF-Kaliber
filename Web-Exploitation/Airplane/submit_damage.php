<?php
session_start();

$damage = isset($_POST['damage']) ? intval($_POST['damage']) : 0;
$shots = isset($_POST['shots']) ? intval($_POST['shots']) : 0;

$_SESSION['total_damage'] += $damage;
$_SESSION['shots_fired'] += $shots;

if ($damage < 0) {

    $encoded = "S2FsaWJlcntuM2c0dDF2M19kNG00ZzNfYlIzNGtzX3Y0bDFkNHQxMG59";
    
    $flag = base64_decode($encoded);
    ?>
    <!DOCTYPE html>
    <html lang="id">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>SYSTEM CRASH - Critical Error</title>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="crash-screen">
            <div class="crash-container">
                <div class="crash-header">
                    <h1>üí• CRITICAL SYSTEM ERROR</h1>
                    <div class="error-code">ERROR CODE: 0xDEADBEEF</div>
                </div>

                <div class="crash-body">
                    <div class="error-message">
                        <h2>‚ö†Ô∏è GAME ENGINE CRASHED</h2>
                        <p>The damage calculation module has encountered a fatal error.</p>
                    </div>

                    <div class="error-details">
                        <h3>üìã Error Details:</h3>
                        <table>
                            <tr>
                                <td><strong>Module:</strong></td>
                                <td>DamageValidator.dll</td>
                            </tr>
                            <tr>
                                <td><strong>Function:</strong></td>
                                <td>calculateDamage()</td>
                            </tr>
                            <tr>
                                <td><strong>Expected Value:</strong></td>
                                <td>10 - 30</td>
                            </tr>
                            <tr>
                                <td><strong>Received Value:</strong></td>
                                <td class="error-value"><?php echo htmlspecialchars($damage); ?></td>
                            </tr>
                            <tr>
                                <td><strong>Status:</strong></td>
                                <td class="status-critical">SYSTEM FAILURE</td>
                            </tr>
                        </table>
                    </div>

                    <div class="stack-trace">
                        <h3>üêõ Stack Trace:</h3>
                        <pre>
at GameEngine.Weapons.calculateDamage(Int32 damage) in C:\Game\Weapons.cs:line 127
at GameEngine.Combat.processHit(Enemy target, Int32 damage) in C:\Game\Combat.cs:line 89
at GameEngine.Validator.validateDamage(Int32 value) in C:\Game\Validator.cs:line 42

System.ArgumentOutOfRangeException: Damage value out of valid range
Parameter name: damage
Actual value was <?php echo $damage; ?>.
Expected: 10 <= damage <= 30

   at System.ThrowHelper.ThrowArgumentOutOfRangeException()
   at GameEngine.Weapons.calculateDamage(Int32 damage)
   at GameEngine.Combat.processHit(Enemy target, Int32 damage)
                        </pre>
                    </div>

                    <div class="memory-dump">
                        <h3>üíæ Memory Dump:</h3>
                        <pre><?php

$hex = '';
$ascii = '';
for($i = 0; $i < strlen($flag); $i++) {
    if($i % 16 == 0) {
        if($i > 0) {
            echo '  ' . $ascii . "\n";
            $ascii = '';
        }
        echo sprintf('0x%08X: ', $i);
    }
    
    $byte = ord($flag[$i]);
    echo sprintf('%02X ', $byte);

    $ascii .= ($byte >= 32 && $byte <= 126) ? $flag[$i] : '.';
    
    if(($i + 1) % 8 == 0 && ($i + 1) % 16 != 0) {
        echo ' ';
    }
}

$remaining = strlen($flag) % 16;
if($remaining > 0) {
    $padding = (16 - $remaining) * 3;
    if($remaining <= 8) $padding += 1;
    echo str_repeat(' ', $padding) . '  ' . $ascii;
}
?>
                        </pre>
                    </div>

                    <div class="flag-reveal">
                        <h3>üö© SYSTEM FLAG LEAKED:</h3>
                        <div class="flag-box" id="flagBox">
                            <?php echo htmlspecialchars($flag); ?>
                        </div>
                        <p class="flag-subtitle">‚ö†Ô∏è Debug information exposed due to unhandled exception</p>
                    </div>
                    <a href="index.php" class="btn-restart">üîÑ RESTART GAME</a>
                </div>
            </div>
        </div>

        <script>

        (function() {
            const flagBox = document.getElementById('flagBox');
            const originalText = flagBox.textContent;
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789{}_ ';
            
            let iteration = 0;
            const interval = setInterval(() => {
                flagBox.textContent = originalText.split('').map((char, index) => {
                    if(index < iteration) {
                        return originalText[index];
                    }
                    return chars[Math.floor(Math.random() * chars.length)];
                }).join('');
                
                if(iteration >= originalText.length) {
                    clearInterval(interval);
                    flagBox.textContent = originalText;
                }
                
                iteration += 1/3;
            }, 30);
        })();
        </script>
    </body>
    </html>
    <?php
    exit();
}

if ($damage > 0) {
    $_SESSION['enemies_destroyed']++;
    header('Location: index.php?success=1&damage=' . $damage);
} else {
    header('Location: index.php?error=invalid');
}
exit();
?>