let userCoins = parseInt(document.getElementById('coinsAmount').textContent);

function updateCoins(amount) {
    userCoins = amount;
    document.getElementById('coinsAmount').textContent = userCoins;
}

async function openChest(chestType, price) {
    const payload = {
        item: chestType,
        price: price
    };

    try {
        const response = await fetch('api/openChest.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
            updateCoins(data.remaining_coins);
            showSuccessModal(data);
        } else {
            showErrorModal(data.message);
        }
    } catch (error) {
        showErrorModal('Network error occurred');
    }
}

function showSuccessModal(data) {
    const modal = document.getElementById('resultModal');
    const modalBody = document.getElementById('modalBody');

    let rewardsList = '';
    if (data.rewards) {
        rewardsList = '<ul class="rewards-list">';
        data.rewards.forEach(reward => {
            rewardsList += `<li>‚ú® ${reward}</li>`;
        });
        rewardsList += '</ul>';
    }

    let flagSection = '';
    if (data.flag) {
        flagSection = `
            <div class="flag-section">
                <h3>üö© SPECIAL REWARD UNLOCKED!</h3>
                <div class="flag-box">${data.flag}</div>
            </div>
        `;
    }

    modalBody.innerHTML = `
        <div class="success-content">
            <div class="success-icon">üéâ</div>
            <h2>Chest Unlocked!</h2>
            <p class="chest-type">${data.chest_type.replace('_', ' ').toUpperCase()}</p>
            <div class="rewards-section">
                <h3>üéÅ Rewards:</h3>
                ${rewardsList}
            </div>
            ${flagSection}
            <div class="coins-info-modal">
                <p>Coins spent: <span class="coins-spent">-${data.coins_spent}</span></p>
                <p>Remaining: <span class="coins-remaining">${data.remaining_coins}</span></p>
            </div>
        </div>
    `;

    modal.style.display = 'flex';
}

function showErrorModal(message) {
    const modal = document.getElementById('resultModal');
    const modalBody = document.getElementById('modalBody');

    modalBody.innerHTML = `
        <div class="error-content">
            <div class="error-icon">‚ùå</div>
            <h2>Failed to Unlock</h2>
            <p>${message}</p>
        </div>
    `;

    modal.style.display = 'flex';
}

function closeModal() {
    document.getElementById('resultModal').style.display = 'none';
}

window.onclick = function(event) {
    const modal = document.getElementById('resultModal');
    if (event.target === modal) {
        modal.style.display = 'none';
    }
}