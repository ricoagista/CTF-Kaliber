<?php
require_once '../config.php';

header('Content-Type: application/json');

if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
    echo json_encode(['success' => false, 'message' => 'Invalid request method']);
    exit();
}

$input = file_get_contents('php://input');
$data = json_decode($input, true);

$chestType = isset($data['item']) ? $data['item'] : '';
$price = isset($data['price']) ? intval($data['price']) : 0;

if (empty($chestType)) {
    echo json_encode(['success' => false, 'message' => 'Chest type is required']);
    exit();
}

$userCoins = $_SESSION['user_coins'];

if ($userCoins < $price) {
    echo json_encode([
        'success' => false, 
        'message' => 'Insufficient coins',
        'coins' => $userCoins
    ]);
    exit();
}

$query = "SELECT * FROM chests WHERE chest_type = '" . mysqli_real_escape_string($conn, $chestType) . "'";
$result = mysqli_query($conn, $query);

if (mysqli_num_rows($result) === 0) {
    echo json_encode(['success' => false, 'message' => 'Chest not found']);
    exit();
}

$chest = mysqli_fetch_assoc($result);

$_SESSION['user_coins'] -= $price;

$response = [
    'success' => true,
    'message' => 'Chest unlocked successfully!',
    'chest_type' => $chestType,
    'coins_spent' => $price,
    'remaining_coins' => $_SESSION['user_coins']
];

if (!empty($chest['flag_content'])) {
    $response['flag'] = $chest['flag_content'];
    $response['special_reward'] = true;
}

switch($chestType) {
    case 'basic_chest':
        $response['rewards'] = ['10 Gold', '2 Potions', '1 Scroll'];
        break;
    case 'silver_chest':
        $response['rewards'] = ['50 Gold', '5 Potions', '3 Scrolls', '1 Magic Gem'];
        break;
    case 'gold_chest':
        $response['rewards'] = ['200 Gold', '10 Potions', '5 Magic Gems', '1 Epic Sword'];
        break;
    case 'premium_chest':
        $response['rewards'] = ['1000 Gold', '50 Potions', '20 Magic Gems', '5 Legendary Items'];
        break;
    default:
        $response['rewards'] = ['Mystery Item'];
}

echo json_encode($response);
?>